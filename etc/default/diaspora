export RAILS_ENV=production
export DIASPORA_HOME=/usr/local/app/diaspora
export THIN_USER=nobody
export THIN_GROUP=nogroup

function wait_service() {
	if [ $# -le 0 ]; then echo "missing service" 1>&2; return 1; fi
	for service in $*; do 
		case $service in
		mongo)
			args="localhost 27017"
		;;
		redis)
			args="localhost 6379"
		;;
		smtp)
			args="localhost 25"
		;;
		web)
			args="localhost 80"
		;;
		websocket)
			args="localhost 8080"
		;;
		*)
			echo "unknown '$service'" 1>&2
			return 2
		;;
		esac
		while ! nc -z $args; do echo ${PWD##*/} waiting for $service; sleep 1; done
	done
}

function exec_thin() {
	INSTANCE=${1:?missing instance}

	cd $DIASPORA_HOME || return 1

	LOG=log/thin.$INSTANCE.log
	SOCK=/tmp/thin.$INSTANCE.sock

	touch $LOG || return 2
	chown $THIN_USER:$THIN_GROUP $LOG || return 3
	chmod 640 $LOG || return 4

	exec /usr/local/bin/bundle exec thin \
		-l $LOG \
		-S $SOCK \
		-u ${THIN_USER:-nobody} \
		-g ${THIN_GROUP:-nogroup} \
		-e ${RAILS_ENV:-development} \
		start 
}
